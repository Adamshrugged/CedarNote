{% extends "base.html" %}

{% block title %}Create New Note {% endblock %}

{% block content %}
    <h1>New Note</h1>
    <form method="post" action="/create-note">
        <label for="title">Title (no spaces, no extension):</label><br>
        <input type="text" id="title" name="title" required><br><br>


        <label for="folder">Folder:</label><br>
        <select id="folder" name="folder">
            <option value="">(Root)</option>
            {% for folder in folders %}
                <option value="{{ folder }}">{{ folder }}</option>
            {% endfor %}
        </select><br><br>

        <div class="editor">
            <textarea id="content" name="content" oninput="updatePreview()" required>
---
title: ""
tags: []
category: ""
created: {{ current_date }}
---

# 

</textarea>

            <div id="preview" class="preview"></div>
        </div>
        <br>
        <button type="submit">➕ Create Note</button>
    </form>
    <p><a href="/">← Back to Notes List</a></p>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        function stripFrontmatter(text) {
            // Check if text starts with ---
            if (text.startsWith('---')) {
                const endIndex = text.indexOf('---', 3);  // find the second ---
                if (endIndex !== -1) {
                    // Remove the frontmatter block
                    return text.slice(endIndex + 3).trim();
                }
            }
            return text;
        }
        function convertInternalLinks(text) {
            // Replace [[Note Title]] with <a href="/notes/Note Title.md">Note Title</a>
            return text.replace(/\[\[([^\]]+)\]\]/g, function(match, p1) {
                const link = `/notes/${encodeURIComponent(p1.trim())}.md`;
                return `<a href="${link}">${p1.trim()}</a>`;
            });
        }
        function updatePreview() {
            const rawMarkdown = document.getElementById('content').value;
            const markdownWithoutFrontmatter = stripFrontmatter(rawMarkdown);
            const markdownWithLinks = convertInternalLinks(markdownWithoutFrontmatter);
            document.getElementById('preview').innerHTML = marked.parse(markdownWithLinks);
        }

        // Initialize empty preview on page load
        updatePreview();
    </script>
{% endblock %}