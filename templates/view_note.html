{% extends "base.html" %}
{% block title %}Editing {{ display_title }}{% endblock %}

{% block content %}

<script>
  window.noteFilename = "{{ title }}";
</script>

<!-- Top Info Bar -->
<div class="flex justify-between items-center mb-4">
  <div class="text-xl font-semibold text-green-400">
    ğŸ“ Editing: {{ display_title }}
  </div>
</div>

<!-- Editor Form -->
<form method="post"
      action="/save-note/{{ path }}"
      class="space-y-6">

  <!-- Toolbar -->
  <div class="flex flex-wrap gap-4 items-center bg-gray-800 p-4 rounded shadow">
    <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded">
      ğŸ’¾ Save
    </button>

    {% if true %}
    <button type="button" onclick="confirmDelete()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">
      ğŸ—‘ï¸ Delete
    </button>

    <div class="flex items-center gap-2">
      <label for="destination_folder" class="text-sm">Move:</label>
      <select id="destination_folder" name="destination_folder" class="bg-gray-700 text-white px-2 py-1 rounded">
        {% for folder in folders %}
          <option value="{{ folder }}">{{ '-' * folder.count('/') }} {{ folder if folder else "(Root)" }}</option>
        {% endfor %}
      </select>
      <button type="button" onclick="submitMove()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded">
        ğŸ“‚ Move
      </button>
    </div>
    {% endif %}

    <div class="ml-auto flex gap-2">
      <button type="button" id="toggle-editor" class="text-sm hover:text-green-400">ğŸ“ Toggle Edit</button>
      <button type="button" id="toggle-preview" class="text-sm hover:text-green-400">ğŸ‘ï¸ Toggle Preview</button>
    </div>
  </div>

  <!-- Editor/Preview Area -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div id="editor" class="h-[60vh]">
      <textarea id="content" name="content" required
        class="w-full h-full bg-gray-800 text-white p-4 rounded resize-none border border-gray-600">{{ note_content.strip() }}</textarea>
    </div>

    <div id="preview" class="prose prose-invert bg-gray-800 p-4 rounded overflow-y-auto h-[60vh] border border-gray-700 max-w-none"></div>
  </div>

</form>

<!-- Share Note -->
{% if is_owner %}
  <div class="mt-8 space-y-4">
    <h3 class="text-lg font-semibold">ğŸ”— Share this note</h3>
    <form method="post" action="/share-note/{{ title }}" class="flex gap-4 items-center">
      <label for="recipient" class="text-sm">Share with:</label>
      <select name="recipient" id="recipient" class="bg-gray-700 text-white p-2 rounded">
        {% for user in valid_users %}
          <option value="{{ user }}">{{ user }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">
        Share
      </button>
    </form>

    {% if shared_users %}
      <div>
        <h4 class="font-semibold mb-2">ğŸ‘¥ Shared with:</h4>
        <ul class="space-y-1">
          {% for user in shared_users %}
            <li class="flex justify-between items-center bg-gray-700 p-2 rounded">
              <span>{{ user }}</span>
              <form method="post" action="/unshare-note/{{ title }}">
                <input type="hidden" name="unshare_with" value="{{ user }}">
                <button type="submit" class="text-red-400 hover:text-red-300 text-sm">âœ– Revoke</button>
              </form>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
{% endif %}

<!-- Autosave Indicator -->
<div id="save-status" class="text-sm text-green-400 mt-6">ğŸ’¾ Saved</div>

<!-- Hidden Delete Form -->
<form id="delete-form" method="post" action="/delete-note/{{ path }}"></form>

<!-- Hidden Move Form -->
<form id="move-form" method="post" action="/move-note/{{ username }}/{{ path }}">
  <input type="hidden" name="note_path" id="hidden-note-path" value="{{ title }}">
  <input type="hidden" name="destination_folder" id="hidden-destination-folder">
</form>

<!-- JS Scripts -->
<script>
  function confirmDelete() {
    if (confirm("Delete this note?")) {
      document.getElementById('delete-form').submit();
    }
  }

  function submitMove() {
    const selectedFolder = document.getElementById('destination_folder').value;
    document.getElementById('hidden-destination-folder').value = selectedFolder;
    document.getElementById('move-form').submit();
  }
</script>

<script src="/static/js/marked.min.js"></script>
<script src="/static/js/edit_note.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const contentEl = document.getElementById("content");
      const previewEl = document.getElementById("preview");

      function stripFrontmatter(text) {
        if (text.startsWith('---')) {
          const end = text.indexOf('---', 3);
          if (end !== -1) {
            return text.slice(end + 3).trim();
          }
        }
        return text.trim();
      }

      function updatePreview() {
        const rawText = contentEl.value;
        const stripped = stripFrontmatter(rawText);
        previewEl.innerHTML = marked.parse(stripped);
      }

      // Update on load and every change
      contentEl.addEventListener("input", updatePreview);
      updatePreview();
    });
  </script>

{% endblock %}
